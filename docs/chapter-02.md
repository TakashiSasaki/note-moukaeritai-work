# **第2章: Firebaseアーキテクチャ**

### **目次**

2.1. 利用機能一覧と役割分担  
2.2. アーキテクチャ図

### **2.1. 利用機能一覧と役割分担**

本アプリケーションは、Firebaseが提供する複数のサービスを密に連携させることで、高機能かつスケーラブルなシステムをサーバーレスで構築する。各サービスの役割は以下の通りである。

| 機能 | 役割 |
| :---- | :---- |
| **Firebase Authentication** | **ID管理レイヤー**: 通常および匿名 (Anonymous) ユーザーの認証と識別。各ユーザーに一意のuidを発行し、アカウント連携機能により匿名から登録ユーザーへのシームレスな移行をサポートする。 |
| **Cloud Firestore** | **データベースレイヤー**: アプリケーションのコアとなる構造化データを格納する。ノートのテキストデータ、メタデータ、各種関連情報（リンク、画像URL、ログ）を管理し、リアルタイム同期を実現する。 |
| **Cloud Storage for Firebase** | **ファイルストレージレイヤー**: ユーザーが添付する画像ファイルなどの大容量非構造化データを格納する。 |
| **Cloud Functions for Firebase** | **バックエンドロジックレイヤー**: サーバーサイドの処理を自動化する。主な責務は、1) Callable Functionによるクライアントからのリクエスト処理（ログ記録、インポート/エクスポート）、2) Firestore/Storageトリガーによるデータの一貫性維持とクリーンアップ、3) HTTPトリガーによる動的なWebコンテンツ生成（共有URL）である。 |
| **Firebase Security Rules** | **セキュリティレイヤー**: データとファイルへのアクセス制御を行う。認証状態とuidに基づき、ユーザーが自身のデータにのみアクセスできるよう強制し、アプリケーションのデータセキュリティを担保する。 |
| **Firebase Hosting** | **フロントエンド配信レイヤー**: 静的なWebコンテンツ（HTML, CSS, JS）をホスティングし、ユーザーにUIを提供する。また、特定のパスへのリクエストをCloud Functionsに転送（リライト）するルーティング機能も担う。 |

### **2.2. アーキテクチャ図**

\[アーキテクチャ図\]

\+--------------------------+  
|       クライアント        |  
| (Web/ネイティブアプリ)     |  
\+------------+-------------+  
             |  
             | HTTPS/WSS  
             |  
\+------------v-------------+      \+--------------------------+  
|    Firebase Hosting      |-----\>| Cloud Functions (HTTP)   |  
| (静的コンテンツ配信)     |      |  \- viewNote (共有URL)    |  
\+--------------------------+      \+--------------------------+  
             |  
             | Firebase SDK  
             |  
\+------------v-------------+      \+--------------------------+  
|  Firebase Authentication |      | Cloud Functions (Callable) |  
| (通常/匿名認証, \`uid\`)  |-----\>|  \- logAccess             |  
\+--------------------------+      |  \- migrateUserData       |  
             |                      |  \- exportUserData        |  
             |                      |  \- importUserData        |  
             |                      \+--------------------------+  
             |  
\+------------v-------------+      \+--------------------------+  
|      Cloud Firestore     |-----\>| Cloud Functions (Trigger)|  
| (ノート,ログ,メタデータ)  |      |  \- maintainBacklinks     |  
| \+---------Security Rules |      |  \- cleanupDeletedEntry   |  
\+--------------------------+      |  \- syncPublicNote        |  
             |                      |  \- updateNoteStats       |  
             |                      \+--------------------------+  
             |  
\+------------v-------------+      \+--------------------------+  
|  Cloud Storage for Firebase|-----\>| Cloud Functions (Trigger)|  
|      (画像ファイル)       |      |  \- updateStorageStats    |  
| \+---------Security Rules |      |                          |  
\+--------------------------+      \+--------------------------+
