# **第4章: ストレージ設計 (Cloud Storage)**

### **目次**

4.1. パス構造と命名規則  
4.2. データタイプと制約  
4.3. セキュリティとの連携

### **4.1. パス構造と命名規則**

ユーザーがアプリケーションを通じてアップロードする画像ファイルは、Cloud Storage for Firebaseに格納される。ファイルは、所有ユーザーと関連するノートエントリに基づいて、整理された階層構造で管理される。

#### **4.1.1. 基本パス構造**

users/{userId}/{noteId}/{entryId}/{imageFileName}

* **users/**: 全てのユーザーデータを格納するルートディレクトリ。  
* **{userId}**: ファイルを所有するユーザーのuid。これにより、ユーザーごとのデータ分離が保証される。  
* **{noteId}**: 関連するノートのID (UUID)。  
* **{entryId}**: 関連するノートエントリのID。  
* **{imageFileName}**: クライアント側で生成される一意なファイル名（例: UUID \+ 拡張子）。

この構造により、特定のノートやエントリに関連する画像を効率的に特定できるだけでなく、セキュリティルールの適用範囲を細かく制御することが可能になる。

#### **4.1.2. エクスポート/インポート用パス**

データのエクスポートおよびインポート処理中に生成される一時的なファイルは、専用のパスに格納される。

* **エクスポート用パス**: exports/{userId}/{exportTimestamp}.zip  
* **インポート用パス**: imports/{userId}/{importTimestamp}.zip

これらのファイルは処理完了後にCloud Functionsによって自動的に削除される。

### **4.2. データタイプと制約**

* **許可されるファイルタイプ**: image/jpeg, image/png, image/gif, image/webpなど、一般的な画像形式に限定する。クライアント側でのアップロード前にファイルタイプの検証を行う。  
* **ファイルサイズ制限**: ユーザー体験とコスト管理のため、1ファイルあたりの最大サイズをクライアント側で制限する（例: 10MB）。

### **4.3. セキュリティとの連携**

Cloud Storageのファイルアクセスは、第6章で詳述するStorage Security Rulesによって厳格に制御される。基本原則は「認証されたユーザーは、自身のuidに対応するパス (users/{userId}/...) 以下のファイルにのみアクセス（読み取り、書き込み、削除）できる」というものである。