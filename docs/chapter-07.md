# **第7章: クライアントアーキテクチャ**

### **目次**

7.1. レスポンシブUI (モバイル対応)  
7.2. オフラインサポート (Service Worker)  
7.3. ログ記録プロセス  
7.4. 情報取得

### **7.1. レスポンシブUI (モバイル対応)**

ウェブのユーザーインターフェースは、デスクトップからモバイル端末まで、多様なスクリーンサイズで快適に利用できるよう設計される必要がある。

* **Viewport設定**: HTMLの\<head\>セクションに以下のメタタグを必ず含めること。これにより、モバイル端末での表示スケールが最適化される。  
  \<meta name="viewport" content="width=device-width, initial-scale=1.0"\>

* **デザイン原則**:  
  * **フルードグリッド**: 固定幅ではなく、パーセンテージやvwといった相対単位に基づくレイアウトを採用する。  
  * **フレキシブルメディア**: 画像や動画などのメディア要素が、コンテナの幅を超えないようにする (max-width: 100%)。  
  * **メディアクエリ**: CSSのメディアクエリを用いて、特定のスクリーン幅（ブレークポイント）に応じてレイアウトやスタイルを動的に変更する。

### **7.2. オフラインサポート (Service Worker)**

通信が不安定な状況やオフライン環境でもアプリケーションの基本機能が利用できるよう、Service Workerを導入する。

* **役割**:  
  * **アプリケーションシェルのキャッシュ**: アプリケーションの骨格となるHTML, CSS, JavaScriptファイルをキャッシュする。これにより、次回以降の起動が高速化され、オフラインでもUIが表示可能になる。  
  * **データキャッシュ (Firestore Offline Persistence)**:  
    * Firebase SDKのオフライン持続機能を有効化する。これにより、ユーザーが一度アクセスしたノートデータは自動的にローカルにキャッシュされる。  
    * オフライン中のノートの閲覧、編集、作成、削除が可能になる。  
    * オフライン中に行われた全ての書き込み操作はキューに保存され、ネットワーク接続が回復した際に自動的にサーバーと同期される。

### **7.3. ログ記録プロセス**

* **ログ記録のトリガー**: クライアントは、ノートの読み書き時にFirestoreへ直接ログを書き込むのではなく、**logAccess Callable Functionを呼び出す**。  
* **書き込み (Write) 時**: ノートの更新処理（例: エントリ追加）が成功した**後**に、logAccess関数をtype: "write"で呼び出す。  
* **読み取り (Read) 時**: 第3章で定義したnoteReadStatusコレクションを参照し、最後の読み取りから一定時間が経過した場合にのみ、logAccess関数をtype: "read"で呼び出す。

### **7.4. 情報取得**

クライアントは、ログ記録やその他の機能のために、ユーザーの許可を得た上で以下の情報を取得する。

* **位置情報**: ログ記録の直前に、ユーザーから許可を得た上で位置情報を取得する。ウェブブラウザ環境では、navigator.geolocation API を使用する。ネイティブアプリ環境では、各OSが提供するAPIを使用する。  
* **ネットワーク情報**: ウェブブラウザ環境で利用可能な場合、navigator.connection API を使用してネットワークに関する情報（接続タイプ type、有効帯域 effectiveType など）を取得し、アクセスログに含める。  
* **接続中・周辺Wi-Fi情報**: (ネイティブアプリの場合) ログ記録の直前に、OSのAPIを通じてWi-Fi情報を取得する。  
* **ユーザーエージェント**: ログ記録の際に、クライアントは自身のユーザーエージェント文字列を取得する。