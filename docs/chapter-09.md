# **第9章: ユーザー状態とデータフロー**

### **目次**

9.1. ユーザー状態の定義  
9.2. 匿名ユーザーのライフサイクル  
9.3. 登録ユーザー  
9.4. アカウントの連携（アップグレード）  
9.5. アカウント競合時のデータ移行フロー

### **9.1. ユーザー状態の定義**

本アプリケーションは、ユーザーの認証状態に応じて以下の2つの状態をサポートする。

* **匿名ユーザー (Anonymous User)**: アカウント登録（メールアドレス、Google連携など）を行っていないユーザー。一時的なアカウントでアプリケーションの全機能を利用できる。  
* **登録ユーザー (Permanent User)**: 永続的な認証方法でサインインしたユーザー。複数のデバイス間でデータを同期できる。

### **9.2. 匿名ユーザーのライフサイクル**

* **初期化フロー**:  
  1. クライアントアプリは起動時にユーザーの認証状態を確認する。  
  2. 認証済みのユーザーが存在しない場合、signInAnonymously()を自動的に呼び出す。  
  3. Firebase Authenticationは一時的な匿名アカウントを作成し、一意のuidを発行する。このuidは、ユーザーがアプリデータを消去しない限り、同じデバイス上で維持される。  
* **データ**: 全てのデータは、発行された匿名のuidを用いて/users/{anonymous\_uid}/...以下に保存される。

### **9.3. 登録ユーザー**

* **認証**: メールアドレス/パスワード、Google/AppleなどのOAuthプロバイダを通じて認証を行う。  
* **データ**: 永続的なuidが割り当てられ、全てのデータは/users/{permanent\_uid}/...以下に保存・管理される。

### **9.4. アカウントの連携（アップグレード）**

匿名ユーザーが作成したデータを失うことなく、登録ユーザーへ移行するプロセス。

* **フロー**:  
  1. 匿名利用中のユーザーが、アプリ内で新規アカウント登録（例: Googleでサインイン）を選択する。  
  2. クライアントアプリは、新しい認証情報（Googleのクレデンシャルなど）を使って、現在の匿名ユーザーにlinkWithCredential()を実行する。  
  3. 成功すると、Firebaseのバックエンドで匿名アカウントと新しい永続アカウントが自動的に統合される。  
  4. これまで匿名のuidに紐付いていた全てのデータが、新しい永続的なuidに引き継がれる。

### **9.5. アカウント競合時のデータ移行フロー**

**シナリオ**: 匿名利用中に、既に存在する別のアカウントでログインしようとした場合。

1. **エラー検知**: クライアントは、匿名アカウントに既存の認証情報を連携させようとし、Firebaseから返されるauth/credential-already-in-useエラーを捕捉する。  
2. **ユーザーへの意思確認**: エラーを検知したら、「user@example.comは既に登録されています。現在作成中のデータをこのアカウントに統合してログインしますか？」といった確認ダイアログを表示する。  
3. **データ移行バッチの実行**: ユーザーが同意した場合、クライアントはCloud FunctionsのmigrateUserDataを呼び出す。  
   * **クライアントの役割**: 移行元となる現在の匿名uidと、ログインしようとした認証情報（例: Google IDトークン）をmigrateUserData関数に渡す。  
   * Cloud Functionsの役割:  
     a. 受け取った認証情報から移行先の永続的なuidを特定する。  
     b. 移行元のパス (/users/{anonymous\_uid}) 以下にある全てのデータを、移行先のパス (/users/{permanent\_uid}) 以下にコピー/マージする。  
     c. 移行完了後、元の匿名アカウントに関連するデータを削除する。